# 現状の同時打鍵（Chord）仕様まとめ

現在のコード実装（`chord_engine.rs`, `engine.rs`）に基づく同時打鍵判断の仕様は以下の通りです。

## 1. 基本ロジック

キーが押されたイベント（Down）と離されたイベント（Up）を監視し、バッファ（Pending状態）に保持することで判定を行います。

### 判定のタイミング
- キーが押された時 (Down): 未定義キーなら即座にPass、定義キーならPending追加
- キーが離された時 (Up): 重なり判定の実行

### 同時打鍵（コード）成立の条件
2つのキー（Key A, Key B）が以下の条件を満たした場合に「同時打鍵」とみなされます。

1. **重なり (Overlap) チェック**
   - 以前の「絶対時間 (min_overlap_ms)」による判定から、「**文字キー同志の重なり割合 (Overlap Ratio)**」による判定に変更されました。
   - 先行してDownされたキーをA、次にDownされたキーをBとします。
   - **判定基準**:
     - `A(Down) -> A(Up) -> B(Down) -> B(Up)`: 重なりなし → **同時ではない (Sequential)**
     - `A(Down) -> B(Down) -> B(Up) -> A(Up)`: BがAの中に完全に含まれる (重なり100%) → **同時 (Chord)**
     - `A(Down) -> B(Down) -> A(Up) -> B(Up)`: 部分的な重なり → **割合判定**
       - 計算式: `(A.Up - B.Down) / (B.Up - B.Down)`
       - この割合が設定値（デフォルト **35%**）以上であれば **同時**、未満であれば **同時ではない (連続)** と判定します。

## 2. 判定の流れ

1. **キー押下 (Down)**
   - **未定義キー（Enterや矢印など）の場合**: 即座に `Passthrough` として出力します（待機しません）。
   - **定義済みキーの場合**: `Pending` リストに追加（タイムスタンプ記録）し、Upイベントを待ちます。
   - ※ `chord_window_ms` による時間差チェックは行いません。どれだけ時間が空いても、後述の重なり条件を満たせば同時とみなされます。

2. **キー離上 (Up)**
   - キーが離されたタイミングで、`Pending` にある他のキーとの重なり判定を行います。
   - `overlap_ratio_threshold` を満たせば **同時打鍵 (Chord)** と判定。
   - 満たさなければ **単打 (Tap)**（シーケンシャル入力）と判定。

## 3. 設定パラメータ (`Profile`)

| パラメータ名 | デフォルト値 | 説明 |
| :--- | :--- | :--- |
| `chord_window_ms` | (未使用) | 現在のロジックでは使用されていません（無視されます）。 |
| `overlap_ratio_threshold` | **35%** | 同時押しと判定するために必要な、後発キー押下時間に対する重なり時間の割合。 |
| `max_chord_size` | **2** | 同時押しとして認識する最大キー数（現在はペア判定のみ実装）。 |
| `chord_style` | `TriggerKey` | 判定スタイル（現在は主にトリガーキー方式の挙動）。 |

## 4. 出力とレイアウト解決

判定結果 (`Decision`) は以下のように処理されます。

- **Passthrough (通過)**
  - 定義されていないキー（対象外キー）は、即座にOSへイベントを通過させます。

- **Chord (同時打鍵)**
  - 2つのキーのうち「どちらか」が定義上の「モディファイア（親指キーやTriggerキー）」として機能するかを試行します。
  - 例: キーAとキーBの組み合わせ
    - パターン1: `<KeyA>` というセクションの中に `KeyB` の定義があるか？
    - パターン2: `<KeyB>` というセクションの中に `KeyA` の定義があるか？
  - 定義があればその出力を生成。
  - **Fallback (未定義の場合):** 定義が見つからない場合、2つのキーを「順次単打」されたものとして処理します（ロールオーバー対策）。

- **KeyTap (単打)**
  - 通常の文字キーならその文字を出力。
  - モディファイアキー（例: 親指キー）として設定されているキーの場合、単独で離された時点で「OneShotモディファイア（ラッチ）」として機能し、次の1打鍵にシフト効果を適用します。

## 5. 現状の課題・制約

1. **Overlap判定の厳格性**
   - 現在のコードは「判定時に両方が押されていること」を要求しています。
   - 非常に高速な打鍵で、重なり時間が `min_overlap_ms` を満たす前に片方のキーを離してしまった場合、同時打鍵として認識されない可能性があります。

2. **Up時間の消失**
   - `Pending` 状態のキー管理において、キーを離した時刻（Up Time）を保持していないため、離した後の事後的な重なり判定が正確に行えない構造になっています。

3. **3キー以上の同時押し**
   - 現在はペア（2キー）の総当たりチェックのみ実装されており、3キー以上の同時打鍵は考慮されていません。

## 6. 単打鍵（Single Tap）仕様

単打鍵（1つのキーを押して処理される）の仕様は以下の通りです。

### 判定条件
以下のいずれかの場合に「単打」として確定します。

1. **キー離上 (Up) 時**:
   - `Pending` 状態のキーが、他キーとの同時打鍵（Chord）条件（Overlap Ratio）を満たさずに離された場合。
   - ※既に `Chord` として消費されたキーは単打判定されません。

### 動作フロー

1. **判定 (ChordEngine)**
   - 上記条件を満たすと `Decision::KeyTap` が出力されます。
   - ※以前のような `chord_window_ms` による時間切れ判定（長押しによる強制単打確定）はありません。キーを離すまで判定されません。
   - ※ただし、キーが「親指キー（Modifier）」として設定されている場合は、単独で離されると `LatchOn`（OneShotモディファイア有効化）となり、文字出力 (`KeyTap`) は行われません。

2. **文字解決 (Engine)**
   - 確定したキーに対し、現在の「ステート」に基づいて出力トークンを決定します。
   - **優先度順**:
     1. **ラッチ状態 (Latch)**: 直前にOneShotモディファイア（親指シフト等）が押されていた場合、そのモディファイアのサブプレーンを参照。
     2. **シフト状態 (Shift)**: 物理Shiftキーが押されている場合、「ローマ字小指シフト」セクションを参照。
     3. **通常状態 (Base)**: 上記以外の場合、「ローマ字シフト無し」セクションのベースプレーンを参照。

3. **出力 (Output)**
   - 定義されたトークン（文字列やキーシーケンス）を出力します。
   - 定義がない場合、フォールバックとして「元のスキャンコード」をそのまま出力します（通常のキーボード動作）。
