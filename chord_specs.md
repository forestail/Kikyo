# 現状の同時打鍵（Chord）仕様まとめ

現在のコード実装（`chord_engine.rs`, `engine.rs`）に基づく同時打鍵判断の仕様は以下の通りです。

## 1. 基本ロジック

キーが押されたイベント（Down）と離されたイベント（Up）を監視し、バッファ（Pending状態）に保持することで判定を行います。

### 判定のタイミング
- キーが押された時 (Down)
- キーが離された時 (Up)
- 時間経過によるタイムアウト (Flush)

### 同時打鍵（コード）成立の条件
2つのキー（Key A, Key B）が以下の条件を全て満たした場合に「同時打鍵」とみなされます。

1. **時間差 (Window) チェック**
   - Key AとKey Bの「押下開始時刻 (Down Time)」の差が、設定された `chord_window_ms` (デフォルト **200ms**) 以内であること。

2. **重なり (Overlap) チェック**
   - 設定 `min_overlap_ms` (デフォルト **8ms**) が 0より大きい場合：
     - **判定時点**で両方のキーが **「押されている状態」** であること。
     - 遅い方のキーが押されてから、判定時点（現在時刻）までの経過時間が `min_overlap_ms` 以上であること。
   - ※現在の実装では、判定前に片方のキーが離されてしまうと、重なり時間の計測が正確にできず、同時打鍵とみなされない場合があります（後述の課題）。

## 2. 判定の流れ

1. **キー押下 (Down)**
   - キーを `Pending` リストに追加（タイムスタンプ記録）。
   - その時点で `pending` にある他のキーとのペアについて条件チェックを行う。
   - `min_overlap_ms` が 0 の場合は即座に判定される。正の値の場合は、重なり時間が経過するまで判定は保留される（次のイベントかUp時まで待つ）。

2. **キー離上 (Up)**
   - 一瞬待って重なり時間を稼いだ可能性があるため、再度条件チェックを行う。
   - 同時打鍵が成立すれば `Default::Chord` を出力。
   - 成立しなければ、そのキーは「単打 (Tap)」と確定する。

3. **タイムアウト**
   - `Pending` にあるキーが `chord_window_ms` 以上放置された場合、強制的に「単打」として確定・出力される。

## 3. 設定パラメータ (`Profile`)

| パラメータ名 | デフォルト値 | 説明 |
| :--- | :--- | :--- |
| `chord_window_ms` | **200 ms** | 2つのキー押下の許容最大時間差。これ以上離れると独立した打鍵とみなす。 |
| `min_overlap_ms` | **50 ms** | 2つのキーが同時に押されている必要のある最小時間。誤検知（ロールオーバー）防止用。 |
| `max_chord_size` | **2** | 同時押しとして認識する最大キー数（現在はペア判定のみ実装）。 |
| `chord_style` | `TriggerKey` | 判定スタイル（現在は主にトリガーキー方式の挙動）。 |

## 4. 出力とレイアウト解決

判定結果 (`Decision`) は以下のように処理されます。

- **Chord (同時打鍵)**
  - 2つのキーのうち「どちらか」が定義上の「モディファイア（親指キーやTriggerキー）」として機能するかを試行します。
  - 例: キーAとキーBの組み合わせ
    - パターン1: `<KeyA>` というセクションの中に `KeyB` の定義があるか？
    - パターン2: `<KeyB>` というセクションの中に `KeyA` の定義があるか？
  - 定義があればその出力を生成。
  - **Fallback (未定義の場合):** 定義が見つからない場合、2つのキーを「順次単打」されたものとして処理します（ロールオーバー対策）。

- **KeyTap (単打)**
  - 通常の文字キーならその文字を出力。
  - モディファイアキー（例: 親指キー）として設定されているキーの場合、単独で離された時点で「OneShotモディファイア（ラッチ）」として機能し、次の1打鍵にシフト効果を適用します。

## 5. 現状の課題・制約

1. **Overlap判定の厳格性**
   - 現在のコードは「判定時に両方が押されていること」を要求しています。
   - 非常に高速な打鍵で、重なり時間が `min_overlap_ms` を満たす前に片方のキーを離してしまった場合、同時打鍵として認識されない可能性があります。

2. **Up時間の消失**
   - `Pending` 状態のキー管理において、キーを離した時刻（Up Time）を保持していないため、離した後の事後的な重なり判定が正確に行えない構造になっています。

3. **3キー以上の同時押し**
   - 現在はペア（2キー）の総当たりチェックのみ実装されており、3キー以上の同時打鍵は考慮されていません。

## 6. 単打鍵（Single Tap）仕様

単打鍵（1つのキーを押して処理される）の仕様は以下の通りです。

### 判定条件
以下のいずれかの場合に「単打」として確定します。

1. **キー離上 (Up) 時**:
   - `Pending` 状態のキーが、他のキーと同時打鍵（Chord）成立せずに離された場合。
   - ※既に `Chord` として消費されたキーは単打判定されません。
2. **タイムアウト時**:
   - `Pending` 状態のキーが、キー押下から `chord_window_ms` (200ms) 以上経過した場合（長押し）。

### 動作フロー

1. **判定 (ChordEngine)**
   - 上記条件を満たすと `Decision::KeyTap` が出力されます。
   - ※ただし、キーが「親指キー（Modifier）」として設定されている場合は、単独で離されると `LatchOn`（OneShotモディファイア有効化）となり、文字出力 (`KeyTap`) は行われません。

2. **文字解決 (Engine)**
   - 確定したキーに対し、現在の「ステート」に基づいて出力トークンを決定します。
   - **優先度順**:
     1. **ラッチ状態 (Latch)**: 直前にOneShotモディファイア（親指シフト等）が押されていた場合、そのモディファイアのサブプレーンを参照。
     2. **シフト状態 (Shift)**: 物理Shiftキーが押されている場合、「ローマ字小指シフト」セクションを参照。
     3. **通常状態 (Base)**: 上記以外の場合、「ローマ字シフト無し」セクションのベースプレーンを参照。

3. **出力 (Output)**
   - 定義されたトークン（文字列やキーシーケンス）を出力します。
   - 定義がない場合、フォールバックとして「元のスキャンコード」をそのまま出力します（通常のキーボード動作）。
