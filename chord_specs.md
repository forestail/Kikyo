# 現状の同時打鍵仕様まとめ

現在のコード実装（`chord_engine.rs`）に基づく同時打鍵および親指シフトの判定仕様は以下の通りです。

## 1. 基本アーキテクチャ

`ChordEngine` はキーイベント（Down/Up）を時系列で監視し、`Pending` バッファに一時保存して判定を行います。
判定結果として `Decision` (Passthrough, KeyTap, Chord, LatchOn/Off) を出力します。

### キーの状態管理
- **Pressed**: 現在物理的に押されているキーのセット。
- **Pending**: 判定待ちのキーイベント（押下時刻 `t_down`、離上時刻 `t_up` を保持）。
- **UsedModifiers**: 同時打鍵（またはシフト）の一部として消費されたモディファイアキーを追跡（単独打鍵判定の抑制に使用）。

## 2. 判定ロジック

### 判定のトリガー
1. **キー押下 (Down)**:
   - `Pending` リストに追加。
   - 既存の `Pending` キーとのペア判定を実行（Check Chords）。
2. **キー離上 (Up)**:
   - `Pending` 内の該当キーに `t_up` を記録。
   - ペア判定を実行（Check Chords）。
   - 単独で残ったキー（Lonely Tap）のフラッシュ処理。

### 同時打鍵成立条件

2つのキー（Key A, Key B）が以下の条件を満たす場合、同時打鍵として認定されます。

#### A. 重なり割合 (Overlap Ratio) チェック
後から押されたキー（Key B）の押下時間に対し、2つのキーが同時に押されていた時間の割合で判定します。

**計算式**:
```
Ratio = (Overlap Duration) / (Key B Duration)
```
- **Overlap Duration**: 両方のキーが押されていた期間。
- **Key B Duration**: Key B が押されてから離されるまでの期間（離されていない場合は「現在時刻 - Key B Down」）。

**判定**:
`Ratio >= Threshold (設定値)` ならば **同時打鍵**。

#### B. 特例ロジック

1. **親指シフト・連続シフト (Immediate Continuous Modifier)**
   - 条件:
     - 1打目(A)は通常キー、2打目(B)がモディファイアキー（かつ連続シフト有効）。
     - またはその逆。
   - 挙動:
     - モディファイア側が離されるのを待たず、キーAが離された時点（または即時）で判定を行う場合があります。

2. **文字キー同時打鍵の連続判定 (Char Key Continuous / Rollover)**
   - 条件: `char_key_continuous` が有効かつ、文字キー同士のペアである場合。
   - 挙動:
     - 3つ目のキー(C)が押されたタイミングで、確定していないAとBの判定を強制的に行うことがあります（ロールオーバー対策）。

## 3. 設定パラメータ (`Profile`)

| パラメータ名 | デフォルト | 説明 |
| :--- | :--- | :--- |
| `thumb_shift_overlap_ratio` | **35%** | 親指シフト判定の閾値（※実装上は `char_key_overlap_ratio` と共通または個別設定だが、現在は共通値が参照されやすい）。 |
| `char_key_overlap_ratio` | **35%** | 文字キー同士の同時打鍵判定の閾値。 |
| `thumb_left` / `thumb_right` | (Struct) | 左右親指キーの個別設定。 |
| `char_key_continuous` | `false` | 文字キー同時打鍵における連続シフト（ロールオーバー時の判定）を有効にするか。 |

### 親指キー設定 (`ThumbSideConfig`)
- **key**: 使用するキー（無変換、Spaceなど）。
- **continuous**: 連続シフト（押したまま他のキーを連打）を許可するか。
- **repeat**: キーリピートを許可するか。
- **single_press**: 単独打鍵時の動作。
  - `None`: 何もしない（無効）。
  - `Enable`: 通常のキー入力として出力。
  - `PrefixShift`: 前置シフト（次の1打にシフト効果を適用）。
  - `SpaceKey`: Spaceキーとして出力。

## 4. 出力判定 (`Decision`)

判定アルゴリズムによって導かれる結果は以下の通りです。

- **Chord(A, B)**:
  - 2つのキーを同時打鍵ペアとして出力。
  - 使用されたモディファイアキーは `used_modifiers` に記録され、単独打鍵時の出力が抑制されます。
  - **連続シフト有効時**: モディファイアキーは `Pending` から削除されず、次のキーとの判定に残ります。

- **KeyTap(A)**:
  - 重なり条件を満たさなかった場合、または単独で確定した場合。
  - **親指キーの単独打鍵**:
    - `used_modifiers` に含まれていない（同時打鍵に使われていない）場合のみ、`single_press` 設定に従って出力されます。

- **Passthrough**:
  - 対象外のキーや、Spaceキーの特殊処理（モディファイアでない場合）などで即座に出力されます。

## 5. 既知の挙動詳細

1. **Spaceキーの特例**:
   - Spaceキーが親指シフトキーとして設定されて **いない** 場合、入力遅延を防ぐため、Downイベントで即座に `Passthrough` されます。
   - 親指シフトキーの場合は `Pending` に入り、判定対象となります。

2. **Prefix Shift**:
   - `single_press = PrefixShift` に設定された親指キーを単打すると、`prefix_pending` 状態になります。
   - 次に入力されたキーに対し、強制的にその親指キーとの同時打鍵 (`Chord`) を生成します。

3. **ロールオーバー**:
   - 3キー以上の同時押し（A->B->C）などの場合、ペア（A-B, B-C）ごとの判定となります。
   - `char_key_continuous` が有効であれば、滑らかなロールオーバー入力（Aを押したままB、Bを押したままC...）が可能になります。
